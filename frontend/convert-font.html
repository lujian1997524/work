<!DOCTYPE html>
<html>
<head>
    <title>Font Converter for Three.js</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .result { margin-top: 20px; padding: 10px; border: 1px solid #ccc; }
        button { padding: 10px 20px; margin: 10px 0; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #005c8a; }
        textarea { width: 100%; height: 200px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>TTF转Three.js JSON字体工具</h1>
        <p>选择TTF字体文件，转换为Three.js可用的JSON格式</p>
        
        <input type="file" id="fontFile" accept=".ttf,.otf" />
        <br>
        <button onclick="convertFont()">转换字体</button>
        
        <div class="result" id="result" style="display:none;">
            <h3>转换结果:</h3>
            <textarea id="jsonOutput" readonly></textarea>
            <br>
            <button onclick="downloadJson()">下载JSON文件</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/opentype.js/1.3.4/opentype.min.js"></script>
    <script>
        let convertedFont = null;
        let fontName = '';

        async function convertFont() {
            const fileInput = document.getElementById('fontFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('请选择一个字体文件');
                return;
            }

            fontName = file.name.replace(/\.[^/.]+$/, "");
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const font = opentype.parse(arrayBuffer);
                
                // 创建Three.js格式的字体数据
                const fontData = createThreeJSFont(font);
                
                // 显示结果
                document.getElementById('jsonOutput').value = JSON.stringify(fontData, null, 2);
                document.getElementById('result').style.display = 'block';
                
                convertedFont = fontData;
                
            } catch (error) {
                alert('字体转换失败: ' + error.message);
                console.error(error);
            }
        }

        function createThreeJSFont(font) {
            const scale = 1 / font.unitsPerEm;
            const glyphs = {};
            
            // 只转换常用汉字和ASCII字符
            const commonChars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz中国制造工程设计图纸标注尺寸技术参数材料厚度长度宽度高度直径半径圆弧线段文字说明项目名称编号日期版本作者审核批准单位公司部门';
            
            for (let char of commonChars) {
                const glyph = font.charToGlyph(char);
                if (glyph && glyph.path) {
                    const path = glyph.path;
                    const commands = [];
                    
                    path.commands.forEach(cmd => {
                        switch(cmd.type) {
                            case 'M':
                                commands.push({type: 'M', x: cmd.x * scale, y: cmd.y * scale});
                                break;
                            case 'L':
                                commands.push({type: 'L', x: cmd.x * scale, y: cmd.y * scale});
                                break;
                            case 'C':
                                commands.push({
                                    type: 'C',
                                    x1: cmd.x1 * scale, y1: cmd.y1 * scale,
                                    x2: cmd.x2 * scale, y2: cmd.y2 * scale,
                                    x: cmd.x * scale, y: cmd.y * scale
                                });
                                break;
                            case 'Q':
                                commands.push({
                                    type: 'Q',
                                    x1: cmd.x1 * scale, y1: cmd.y1 * scale,
                                    x: cmd.x * scale, y: cmd.y * scale
                                });
                                break;
                            case 'Z':
                                commands.push({type: 'Z'});
                                break;
                        }
                    });
                    
                    glyphs[char.charCodeAt(0)] = {
                        ha: glyph.advanceWidth * scale,
                        x_min: glyph.xMin * scale,
                        x_max: glyph.xMax * scale,
                        o: commands.map(cmd => {
                            if (cmd.type === 'M') return `m ${cmd.x},${cmd.y}`;
                            if (cmd.type === 'L') return `l ${cmd.x},${cmd.y}`;
                            if (cmd.type === 'C') return `c ${cmd.x1},${cmd.y1} ${cmd.x2},${cmd.y2} ${cmd.x},${cmd.y}`;
                            if (cmd.type === 'Q') return `q ${cmd.x1},${cmd.y1} ${cmd.x},${cmd.y}`;
                            if (cmd.type === 'Z') return 'z';
                            return '';
                        }).join(' ')
                    };
                }
            }
            
            return {
                glyphs: glyphs,
                familyName: font.names.fontFamily.en || fontName,
                ascender: font.ascender * scale,
                descender: font.descender * scale,
                underlinePosition: font.tables.post.underlinePosition * scale,
                underlineThickness: font.tables.post.underlineThickness * scale,
                boundingBox: {
                    yMin: font.tables.head.yMin * scale,
                    yMax: font.tables.head.yMax * scale,
                    xMin: font.tables.head.xMin * scale,
                    xMax: font.tables.head.xMax * scale
                },
                resolution: 1000,
                original_font_information: {
                    format: 0,
                    copyright: '转换自TTF字体',
                    description: '使用自定义工具转换的Three.js字体',
                    designer: '未知',
                    designer_url: '',
                    manufacturer: '未知',
                    trademark: '',
                    full_font_name: font.names.fullName?.en || fontName,
                    font_family_name: font.names.fontFamily?.en || fontName,
                    font_sub_family_name: font.names.fontSubfamily?.en || 'Regular',
                    unique_identifier: fontName + '_Regular',
                    version: '1.0'
                }
            };
        }

        function downloadJson() {
            if (!convertedFont) return;
            
            const dataStr = JSON.stringify(convertedFont, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = fontName + '_regular.typeface.json';
            link.click();
        }
    </script>
</body>
</html>